
/*
  This Source Code Form is subject to the terms of the Mozilla Public
  License, v. 2.0. If a copy of the MPL was not distributed with this
  file, You can obtain one at http://mozilla.org/MPL/2.0/.

  Copyright (c) 2015-2016 Alexander Williams, Unscramble <license@unscramble.jp>
 */
(function(){"use strict";var e,t,o,n,r,a,i,s,d,l,u,p,c,k,f,g,v,w,m,h,b,j,C,y,I,P,T,D,_,A,S,N,q,E,x,M;e=null!=window.location.origin?window.location.origin:window.location.protocol+"//"+window.location.hostname+(null!=window.location.port?":"+window.location.port:""),_=function(e){var t,o,n;return $("#login-remember").is(":checked")?(t=new Date,n=864e5,o=30,t.setTime(+t+o*n),document.cookie="jidoteki-admin-api-token="+e+"; expires="+t.toGMTString()+"; path=/"):document.cookie="jidoteki-admin-api-token="+e+"; path=/"},c=function(){return(document.cookie.match("(^|; )jidoteki-admin-api-token=([^;]*)")||0)[2]},r=function(){return document.cookie="jidoteki-admin-api-token=;"},o=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},u=function(e){var t;return t=forge.md.sha256.create(),t.update(e),t.digest().toHex()},l=function(e,t){var o;return o=forge.hmac.create(),o.start("sha256",t),o.update(e),o.digest().toHex()},s=function(t,o){var n,r;return r=c(),null!=r?(n=l("GET"+t,r),$.get(""+e+t+"?hash="+n).done(function(e){return o(null,e)}).fail(function(e){return o(new Error(e))})):o(new Error("Missing or invalid API token"))},d=function(t,o){var n,r;return r=c(),null!=r?(n=l("GET"+t,r),$(location).attr("href",""+e+t+"?hash="+n)):o(new Error("Missing or invalid API token"))},D=function(t,o,n,r){var a,s;return s=c(),null!=s?(a=l("POST"+o,s),$(".jido-page-content-"+t+" .progress .progress-bar").removeClass("progress-bar-danger"),$(".jido-page-content-"+t+" .progress .progress-bar").removeClass("progress-bar-primary"),$(".jido-page-content-"+t+" .progress .progress-bar").addClass("progress-bar-striped"),$(".jido-page-content-"+t+" .progress .progress-bar").attr("progress-bar-striped",33),$(".jido-page-content-"+t+" .progress .progress-bar").attr("aria-valuenow",33),$(".jido-page-content-"+t+" .progress .progress-bar").html("....uploading, please wait"),$(".jido-page-content-"+t+" .progress .progress-bar").attr("style","width: 33%"),$(".jido-page-content-"+t+" .progress").show(),$.ajax({url:""+e+o+"?hash="+a,type:"POST",data:n,processData:!1,contentType:!1,success:function(e,o,n){return N(t),r(null,e)},error:function(e,o,n){return i(t,"upload failed"),r(new Error(n))}})):r(new Error("Missing or invalid API token"))},N=function(e){return $(".jido-page-content-"+e+" .progress").show(),$(".jido-page-content-"+e+" .progress .progress-bar").addClass("progress-bar-primary"),$(".jido-page-content-"+e+" .progress .progress-bar").attr("progress-bar-striped",66),$(".jido-page-content-"+e+" .progress .progress-bar").attr("aria-valuenow",66),$(".jido-page-content-"+e+" .progress .progress-bar").html("...updating"),$(".jido-page-content-"+e+" .progress .progress-bar").attr("style","width: 66%")},q=function(e){return $(".jido-page-content-"+e+" .progress .progress-bar").removeClass("progress-bar-striped"),$(".jido-page-content-"+e+" .progress .progress-bar").addClass("progress-bar-success"),$(".jido-page-content-"+e+" .progress .progress-bar").attr("aria-valuenow",100),$(".jido-page-content-"+e+" .progress .progress-bar").html("done"),$(".jido-page-content-"+e+" .progress .progress-bar").attr("style","width: 100%")},i=function(e,t){return $(".jido-page-content-"+e+" .progress .progress-bar").removeClass("progress-bar-striped"),$(".jido-page-content-"+e+" .progress .progress-bar").addClass("progress-bar-danger"),$(".jido-page-content-"+e+" .progress .progress-bar").attr("aria-valuenow",100),$(".jido-page-content-"+e+" .progress .progress-bar").html(t),$(".jido-page-content-"+e+" .progress .progress-bar").attr("style","width: 100%"),$("."+e+"-form").show(),$("."+e+"-alert").hide()},p=function(e,t){return s("/api/v1/admin/"+e,function(o,n){var r;return o?void 0:($(".jido-data-"+e+"-status").html(n.status),$(".jido-data-"+e+"-log").html("object"==typeof n.log?"No log file found":n.log.replace(/\\n/g,"<br/>")),r=function(){switch(n.status){case"failed":return"label-danger";case"success":return"label-success";case"running":return"label-primary";default:return $(".jido-data-"+e+"-status").html("waiting for "+e),"label-default"}}(),$(".jido-data-"+e+"-status").removeClass("label-danger"),$(".jido-data-"+e+"-status").removeClass("label-success"),$(".jido-data-"+e+"-status").removeClass("label-default"),$(".jido-data-"+e+"-status").addClass(r),t(n.status))})},T=function(e){var t;return $("."+e+"-form").hide(),$("."+e+"-alert").show(),t=setInterval(function(){return p(e,function(o){return"failed"===o?(clearInterval(t),i(e,"failed")):"success"===o?(clearInterval(t),q(e)):"running"===o?N(e):void 0})},1e3)},A=function(e){var t;return t=setInterval(function(){return clearInterval(t),$(location).attr("href",e)},5e3)},t=function(e){return s("/api/v1/admin/version",function(t,o){return t?(r(),e(t)):e(null)})},k=function(){return $("#jido-page-login").hide(),$(".jido-page-content").hide(),$("#jido-page-navbar .navbar-nav li").removeClass("active"),$("#jido-button-home").addClass("active"),$("#jido-page-navbar").show(),$("#jido-page-dashboard").show(),s("/api/v1/admin/version",function(e,t){return e?void 0:$(".jido-data-platform-version").html(t.version)}),s("/api/v1/admin/changelog",function(e,t){return e?void 0:$(".jido-data-changelog").html(t)}),s("/api/v1/admin/settings",function(e,t){var n,r,a;return e?void 0:(r=function(){var e,r;e=t.network,r=[];for(n in e)a=e[n],"ip_address"===n&&(n="IP address"),"dns1"===n&&(n="DNS 1"),"dns2"===n&&(n="DNS 2"),r.push('<li class="list-group-item">'+o(n)+' <span class="pull-right text-primary">'+a+"</span></li>");return r}(),$(".jido-data-network-info").html(r))})},h=function(e){return $("#jido-page-login").hide(),$(".jido-page-content").hide(),$("#jido-page-navbar .navbar-nav li").removeClass("active"),$("#jido-button-"+e).addClass("active"),$("#jido-page-navbar").show(),$(".jido-page-content-"+e).show(),s("/api/v1/admin/version",function(e,t){return e?void 0:$(".jido-data-platform-version").html(t.version)}),p(e,function(t){return"running"===t?T(e):void 0})},g=function(){return $("#jido-page-login").hide(),$(".jido-page-content").hide(),$("#jido-page-navbar .navbar-nav li").removeClass("active"),$("#jido-button-network").addClass("active"),$("#jido-page-navbar").show(),$("#jido-page-network").show(),s("/api/v1/admin/version",function(e,t){return e?void 0:$(".jido-data-platform-version").html(t.version)}),s("/api/v1/admin/settings",function(e,t){var n,r,a;return e?void 0:($(".network-form input.form-control").val(""),null==t.network["interface"]&&$("#interface-input").val("eth0"),r=function(){var e,r;e=t.network,r=[];for(n in e)a=e[n],$("#"+n+"-input").val(a),"ip_address"===n&&(n="IP address"),"dns1"===n&&(n="DNS 1"),"dns2"===n&&(n="DNS 2"),r.push('<li class="list-group-item">'+o(n)+' <span class="pull-right label label-primary">'+a+"</span></li>");return r}(),$(".jido-data-network-info").html(r))})},m=function(){return $("#jido-page-login").hide(),$(".jido-page-content").hide(),$("#jido-page-navbar .navbar-nav li").removeClass("active"),$("#jido-button-token").addClass("active"),$("#jido-page-navbar").show(),$("#jido-page-token").show(),$(".jido-page-content-token .jido-panel-network").show(),$(".token-form .token-token1-label").focus(),s("/api/v1/admin/version",function(e,t){return e?void 0:$(".jido-data-platform-version").html(t.version)}),$(".token-form input.form-control").val("")},v=function(){return $("#jido-page-login").hide(),$(".jido-page-content").hide(),$("#jido-page-navbar").hide(),$("#jido-page-token").show(),$(".jido-page-content-token .jido-panel-network").show(),$(".token-form .token-token1-label").focus(),$(".token-form input.form-control").val("")},w=function(){return $("#jido-page-login").hide(),$(".jido-page-content").hide(),$("#jido-page-navbar .navbar-nav li").removeClass("active"),$("#jido-button-support").addClass("active"),$("#jido-page-navbar").show(),$("#jido-page-support").show(),s("/api/v1/admin/version",function(e,t){return e?void 0:$(".jido-data-platform-version").html(t.version)})},f=function(){return $(".jido-page-content").hide(),$("#jido-page-navbar").hide(),$("#jido-page-login").show(),$("#login-password").focus()},j=function(){return $("#jido-button-logout").click(function(){return r(),f()})},b=function(){return $("#jido-button-login").click(function(){var e,o;return e=$("#login-password").val(),e.length>=8&&e.length<=64&&(o=u(e)),null!=o?(_(o),t(function(e){return e?($("#invalid-token").show(),$("#login-password").focus()):($("#login-password").val(""),$("#invalid-token").hide(),k())})):($("#invalid-token").show(),$("#login-password").focus())})},P=function(){return $("#new-token").click(function(){return v()})},x=function(){return $("#jido-button-update-upload").click(function(){var e;return e=new FormData,e.append("update",$("#update-input[type=file]")[0].files[0]),e?D("update","/api/v1/admin/update",e,function(e,t){return e?void 0:T("update")}):void 0})},I=function(){return $("#jido-button-network-upload").click(function(){var e,t,o,n;if(n=new Object,n.app={},n.network={},n.network.hostname=$("#hostname-input").val(),n.network["interface"]=$("#interface-input").val(),n.network.ip_address=$("#ip_address-input").val(),n.network.netmask=$("#netmask-input").val(),n.network.gateway=$("#gateway-input").val(),$("#dns1-input").val()&&(n.network.dns1=$("#dns1-input").val()),$("#dns2-input").val()&&(n.network.dns2=$("#dns2-input").val()),!n.network.hostname||!validator.isFQDN(n.network.hostname,{require_tld:!1}))return $(".network-form .network-hostname-label").parent().addClass("has-error"),$(".network-form .network-hostname-label").html("Hostname (required)"),void $(".network-form .network-hostname-label").focus();if(!n.network["interface"]||!validator.isAlphanumeric(n.network["interface"]))return $(".network-form .network-interface-label").parent().addClass("has-error"),$(".network-form .network-interface-label").html("Interface (required)"),void $(".network-form .network-interface-label").focus();if($(".jido-data-network-status").removeClass("label-danger"),$(".jido-data-network-status").removeClass("label-success"),$(".jido-data-network-status").removeClass("label-default"),n.network.ip_address&&n.network.netmask&&n.network.gateway){if(!validator.isIP(n.network.ip_address))return $(".network-form .network-ip_address-label").parent().addClass("has-error"),void $(".network-form .network-ip_address-label").focus();if(!validator.isIP(n.network.netmask)&&!validator.isInt(n.network.netmask.replace("/",""),{min:1,max:128}))return $(".network-form .network-netmask-label").parent().addClass("has-error"),void $(".network-form .network-netmask-label").focus();if(!validator.isIP(n.network.gateway))return $(".network-form .network-gateway-label").parent().addClass("has-error"),void $(".network-form .network-gateway-label").focus();if(!validator.isIP(n.network.dns1))return $(".network-form .network-dns1-label").parent().addClass("has-error"),void $(".network-form .network-dns1-label").focus();if(!validator.isIP(n.network.dns2))return $(".network-form .network-dns2-label").parent().addClass("has-error"),void $(".network-form .network-dns2-label").focus();$(".jido-data-network-status").html("STATIC"),$(".jido-data-network-status").addClass("label-success")}else $(".jido-data-network-status").html("DHCP"),$(".jido-data-network-status").addClass("label-success"),delete n.network.ip_address,delete n.network.netmask,delete n.network.gateway,delete n.network.dns1,delete n.network.dns2;return o=new FormData,t=JSON.stringify(n),e=new Blob([t],{type:"application/json"}),e.lastModifiedDate=new Date,o.append("settings",e,"settings.json"),o?D("network","/api/v1/admin/settings",o,function(e,t){var o,r;return e?void 0:(q("network"),n.network.ip_address?(o=validator.isIP(n.network.ip_address,4)?n.network.ip_address:"["+n.network.ip_address+"]",r=window.location.protocol+"//"+o+(null!=window.location.port?":"+window.location.port:""),$(".network-alert").html('Redirecting to <a href="'+r+'">'+r+"</a> in 5 seconds"),$(".network-alert").show(),A(r)):g())}):void 0})},n=function(){return $("#jido-button-certs-upload").click(function(){var e;return e=new FormData,e.append("public",$("#public-key-input[type=file]")[0].files[0]),e.append("private",$("#private-key-input[type=file]")[0].files[0]),$("#ca-key-input[type=file]")[0].files[0]&&e.append("ca",$("#ca-key-input[type=file]")[0].files[0]),e?D("certs","/api/v1/admin/certs",e,function(e,t){return e?void 0:T("certs")}):void 0})},M=function(e){return $("#jido-button-"+e+"-fulllog").click(function(){return s("/api/v1/admin/"+e+"/log",function(t,o){return t?void 0:($("#jido-button-"+e+"-fulllog").addClass("active"),$(".jido-data-"+e+"-full-log").parent().show(),$(".jido-data-"+e+"-full-log").html(o?o:"No log file found"))})})},E=function(){return $("#jido-button-token-upload").click(function(){var e,t,o,n;return t=$("#token1-input").val(),o=$("#token2-input").val(),t?o?t!==o?($(".token-alert").html("API Token mismatch. Please verify the API Token."),void $(".token-alert").show()):(t.length>=8&&t.length<=64&&(n=u(t)),null==n?($(".token-alert").html("Invalid API Token. Must be between 8 and 64 characters"),$(".token-alert").show(),$(".token-form .token-token1-label").parent().addClass("has-error"),$(".token-form .token-token1-label").html("API Token (required)"),$(".token-form .token-token2-label").parent().addClass("has-error"),$(".token-form .token-token2-label").html("Confirm API Token (required)"),void $(".token-form .token-token1-label").focus()):(e=new FormData,e.append("newtoken",t),e?D("token","/api/v1/admin/setup",e,function(e,t){return e?($(".jido-data-token-status").html("failed"),$(".jido-data-token-status").removeClass("label-danger"),$(".jido-data-token-status").removeClass("label-success"),$(".jido-data-token-status").removeClass("label-default"),$(".jido-data-token-status").addClass("label-danger"),i("token")):($(".jido-data-token-status").html("changed"),$(".jido-data-token-status").removeClass("label-danger"),$(".jido-data-token-status").removeClass("label-success"),$(".jido-data-token-status").removeClass("label-default"),$(".jido-data-token-status").addClass("label-success"),$(".token-alert").hide(),_(n),q("token"),$("#token1-input").val(""),$("#token2-input").val(""),$(".jido-page-content-token .jido-panel-network").hide(),m())}):void 0)):($(".token-form .token-token2-label").parent().addClass("has-error"),$(".token-form .token-token2-label").html("Confirm API Token (required)"),void $(".token-form .token-token2-label").focus()):($(".token-form .token-token1-label").parent().addClass("has-error"),$(".token-form .token-token1-label").html("API Token (required)"),void $(".token-form .token-token1-label").focus())})},C=function(){return $("#jido-data-logs-files").click(function(){return d("/api/v1/admin/logs",function(e){})})},a=function(){return $("#jido-data-debug-files").click(function(){return d("/api/v1/admin/debug",function(e){})})},S=function(){return $("#jido-button-restart-confirm").click(function(){return s("/api/v1/admin/reboot",function(e){e||$(".restart-alert").show()})})},y=function(){return $("#jido-page-navbar .navbar-nav li a").click(function(){var e;switch(e=$(this).parent().attr("id")){case"jido-button-home":return k();case"jido-button-update":return h("update");case"jido-button-network":return g();case"jido-button-certs":return h("certs");case"jido-button-license":return loadLicense();case"jido-button-token":return m();case"jido-button-support":return w()}})},j(),b(),P(),x(),I(),n(),E(),M("update"),C(),a(),S(),y(),t(function(e){return e?f():k()})}).call(this);
